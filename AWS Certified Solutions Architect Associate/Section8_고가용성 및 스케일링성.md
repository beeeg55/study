# Section8. 고가용성 및 스케일링성

Date: June 4, 2023

고가용성 및 스케일링성

- 고가용성
    - 애플리케이션 또는 시스템을 적어두 둘 이상의 AZ나 데이터 센터에서 가동중을 의미 → 데이터센터의 손실에서 살아남기
- 수직확장성/수평확장성
    - 수직확장성 - 인스턴스 사이즈 업다운 (스케얼업/스케일다운)
    - 수평확장성 - 인스턴스 개수 업다운(스케일아웃/스케일인)

load balancing 

- 서버 혹은 서버셋으로 트래픽을 백엔드나 인스턴스, 서버들로 전달하는 역할(부하를 분산)
- 사용자로 써는 한 엔드포인트만 바라봄

로드 밸런서 사용 이유

- 부하를 다수의 다운스트림 인스턴스로 분산
- 애플리케이션에 단일 액세스지점 (DNS)를 노출하게함
- 다운스트림 인스턴스의 장애를 원활하게 처리 가능 - healthcheck 메커니즘
- SSL 제공 - HTTPS 트래픽 가능
- 쿠키로 고정도 강화
- 영역에 걸친 고가용성
- 클라우드 내에서 개인 트래픽과 공공 트래픽 분리

ELB

- 관리형 로드 밸런서 ( AWS과 관리 및 책임)
- EC2, 오토스케일링 그룹 등 다수의 AWS 서비스들과 통합됨
- 헬스체크 - 포트와 라우트를 통해 접근 (/health) 하며 정상일경우 200 리턴 - 대상그룹 레벨에서 함
- 고정 호스트이름이 부여됨
- 애플리케이션은 클라이언트의 실제 ip를 직접보지못하며 X-forwarded-for 헤더에 삽입 ( 로드밸런스의 사설ip로 ec2에 접근하기때문)
- 종류
    - Application Load Balancer(ALB)
        - http,https,websocket 지원(7계층 전용)
        - HTTP → HTTPS 리다이렉트 지원
        - 타겟그룹에 로드밸런스 해줌
        - 마이크로서비스나 컨테이너 기반 애플리케이션에 좋음
        - 도커, ecs에 적합
        - URL 경로, 호스트 이름, HTTP 헤더 및 쿼리 문자열을 기반으로 트래픽을 다른 대상 그룹으로 라우팅할 수 있다.
        - 타겟그룹 등록가능대상 : ec2, 사설ip주소, 람다 등
    - Network Load Balancer (NLB)
        - TCP, TLS, UDP 지원 (L4 로드밸런서)
        - 초고성능 환경 구성시 사용(지연시간 최소, 초당 수백만건 요청 처리 가능)
        - AZ 별로 하나의 고정 IP를 갖음(탄력적 IP를 각 AZ에 할당가능) -여러개의 고정ip를 가진 appl에 유용
        - 타겟그룹 등록가능대상: 인스턴스, ip주소(private), alb 등
        - 헬스체크 : TCP, HTTP, HTTPS 프로토콜 지원
    - Gateway Load Balancer(GWLB)
        - 3계층과 IP Protocal에서 동작
        - **보안, 침입탐지, 방화벽 등에 특화 → 네트워크 트래픽을 분석**
        - **투명 네트워크 게이트웨이(모든 트래픽의 단일 출입구) + 로드밸런서 ( 트래픽 분사) 기능**
        - 6081번 포트의 GENEVE 프로토콜 사용
        - 배포, 확장, 타사 네트워크 가상 어플라이언스의 플릿 관리에 사용
        - **프로세스**
            1. **사용자가 요청시 우선 GWLB로 이동**
            2. **gwlb의 타겟그룹(가상 어플라이언스) 에서 방화벽, 침입탐지 등 검사 - 네트워크 트래픽분석**
            3. **다시 GWLB 로 이동**
            4. **정상응답인경우 애플리케이션 인스턴스로 이동**
- [권장]로드밸런서 보안그룹은 80,443 포트 모두 연결 허용 → 인스턴스의 보안그룹을 로드밸런서의 보안그룹으로 연결
    - 로드밸런스로 들어온 트래픽만을 허용하게 만들어 보안강화
    - 로드밸런스의 ip로만 접근을 가능하게함(각각의 인스턴스 ip로 접근막기)

Sticky Session

- 고정성 혹은 고정 세션을 실행하는 것
- 로드밸런서에 요청을 수행하는 클라이언트가 요청에 응답하기 위해 백엔드에 동일한 인스턴스를 갖는것
- ALB에서 설정 가능
- 쿠키를 사용(쿠키가 만료되면 다른 인스턴스도 가능)
    - 어플리케이션 기반 쿠키 ( 어플리케이션에서 기간 지정가능)
        - custom cookie
            - 대상으로 생성된 사용자 정의 쿠키
            - 어플리케이션에 필요한 모든 사용자정의 속성 포함 가능
            - 쿠키 이름은 각 대상그룹별 개별 지정, alb 들어간 이름은 ㄴㄴ
        - application cookie
            - 로드밸런서 자체 생성
            - **쿠키 이름 : awsalbapp**
    - 기간 기반 쿠키
        - 로드밸런서에서 생성
        - **쿠키이름 : awsalb**
        - 특정 기간을 기반으로 만료되며 기간은 로드밸런스 자체에서 생성
        - 

cross-zone load balancing

- 모든 영역에 있는 ec2 인스턴스에 트래픽이 고르게 분배 (가용 영역이 달라도!)
- alb는 교차영역로드밸런싱이 기본 활성화됨(AZ간 데이터 no charge)
- nlb와 gwlb는 기본 비활성화됨(활성화 시 비용지불)

SSL/TLS

- SSL
    - 클라이언트와 로드밸런서 사이에서 트래픽이 이동하는동안 암호화(in-flight암호화)해줌
        - 로드밸런서와 인스턴스사이에서는 ssl이 적용되지않지만 private vpc를 사용하여 안전함
    - 보안 소켓 계층을 의미
- TLS
    - 새로운 버전의 SSL
    - 전송 계층 보안을 의미
    - 최근 TLS를 많이 사용하나 이를 똑같이 ssl이라 부름
- 퍼블릭 인증서는 인증기관(CA- 코모도, 시멘틱 등등)에서 발급
- SSL인증서에는 만료날짜가 있어 주기적으로 업데이트 필요
- 로드밸런서는 x.509 인증서 사용(ssl, tls 서버 인증서라고 부름) - acm(aws certificate manager)에서 관리
- 원하는대로 보안정책 지정가능, 사용자가 직접 인증서를 올릴수있다

**SNI**

- 여러개의 SSL 인증서를 하나의 웹 서버에 로드해 하나의 웹 서버가 여러개의 웹 사이트를 지원할 수 있게 해줌
- 확장된 프로토콜로 최초 SSL 핸드셰이크 단계에 클라이언트가 대상 서버의 호스트 이름을 지정하도록함
- alb, nlb, cloudfront 만 지원

등록 취소지연(연결 드레이닝)

- 인스턴스가 등록 취소, 비정상인 상태에 있을때 인스턴스에 어느정도의 시간을 주어 in-flight 요청, 즉 활성 요청을 완료할 수 있도록 하는 기능
- 인스턴스가 drain 상태면 elb는 등록 취소중인 ec2 인스턴스로 새로운 요청을 보내지않음 → 기존 연결 및 요청 완료 가능
- 시간은 1~3600초로 파라미터에서 설정 가능(0이면 드레이닝이 일어나지 않는것). 기본은 300초

ASG(Auto Scaling Group)

- 웹사이트나 애플리케이션을 배포할때 웹 사이트 방문자가 갈수록 많아지면서 로드가 바뀔 수 있음
- 이때 , 증가/감소한 로드에 맞춰 ec2를 추가하거나(스케일아웃), ec2제거(스케일인)함
- 최소 및 최대 개수를 보장하는 역할도 힘함 -max, min, 최초 개수 설정해줘야함
- asg에 속한 모든 인스턴스가 로드밸런서에 연결
- 비정상 인스턴스가 있는 경우 이를 종료하고 새로운 인스턴스를 생성 → 동작 : 로드밸런서가 health가 이상한 인스턴스를 asg에 알려주면 asg가 종료시킴
- 무료
- launch template : ec2 인스턴스를 시작하는 방법에 대한 정보(ami, 인스턴스타입, ec2 사용자 데이터, ebs 볼륨, ssh키, iam role, 로드밸런서 등) 포함
- 스케일링 정책 - cloudwatch 경보를 기반으로 asg를 스케일 인/아웃함
    - 동적 스케일링 정책
        - 대상 추적 스케일링
            - **기준 수치선을 세우고** 상시 가용이 가능하도록 설정
        - 단순과 단계 스케일링
            - cloudwatch 경보를 설정하고 수치선이 넘으면 용량을 n유닛 추가/ 적으면 n유닛 제거 하도록 설정
            - cloud watch 설정시 단계별로 n개수 설정
        - 예약된 작업
            - 예시. 매주금요일 5시마다 자동으로 10까지 늘림
    - 예측 스케일링
        - 과거 로드를 보고 다음 스케일링을 사전 예약
        - 지표 : cpu 사용률, 대상별 요청 수, 네트워크 입출력 양
        - scaling cooldown : 인스턴스 추가/삭제시 쿨다운타임을 갖어 새로운 인스턴스가 안정화 될수록 함 → 새로운 지표 양상을 보기 위해
        - 즉시사용가능한 aim를 이용하여 ec2 구성시간을 단축하여 처리시키는 것이 좋음