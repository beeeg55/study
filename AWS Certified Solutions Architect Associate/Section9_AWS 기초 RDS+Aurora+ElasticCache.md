# Section9. AWS 기초 : RDS+Aurora+ElasticCache

Date: June 4, 2023

RDS(Relational Database Service)

- SQL을 쿼리 언어로 사용하는 데이터베이스용 관리형 데이터베이스 서비스
- RDS에 db를 생성할 수 있고 이를 AWS가 관리
- db 엔진 유형 : postgres, mysql, mariadb, oracle, microsoft sql server, aurora 등
- 다양한 서비스 제공으로 인스턴스에 db를 두는것과 차별화
    - 데이터베이스 프로비저닝, 운영체제 패치가 자동화 - 지속적 타임스탬프로 특정시점 백업에 좋음
    - 성능을 대시보드에서 모니터링
    - 읽기전용 복제본을 활용해 읽기 성능 개선
    - 다중 az 설정 → 재해 복구 목적
    - 유지관리기간에 업그레이드 가능
    - 인스턴스 유형을 늘려 수직 확정 or 읽기 전용 복제본을 추가하여 수평확장 가능
    - EBS에 구성(Gp2 or io1)
- 단점 : rds 인스턴스에 SSH 액세스가 불가함

RDS - Storage Auto Scailing

- storage auto scailing 기능 활성화 시 임계치가 넘으면 자동으로 확장해줌(최대치 설정해줘야함)
- 모든 rds 지원 엔진에 지원되는 기능

읽기전용 복제본

- 동일한 가용영역,  AZ존 걸쳐서, 리전 걸쳐서 3가지 옵션
- 메인 인스턴스와 읽기전용 복제본 사이에 **비동기식 복제**가 발생
- 복제본을 데이터베이스로 승격 가능
- 어플리케이션은 모든 커넥션을 업데이트 해야 RDS 클러스터 상의 읽기전용 복제본 전체 목록 활용 가능
- SELECT 명령문에만 사용해야함
- 최대 15개까지 가능
- 네트워킹 비용 : 다른 az존이지만 동일한 리전인경우 비용발생 x, 다른 리전에 복제본이 존재하는경우 복제비용 발생

RDS 다중 AZ

- 재해 복구에 사용. 가용성을 높여줌
- **동기식으**로 스탠바이 인스턴스 복제본을 갖고있는것
- 하나의 DNS를 가지게되어 장애가 생겨도 스탠바이 데이터베이스에 자동적으로 장애 조치가 수행
- 앱에 따로 설정할 필요 없음
- 마스터 데이터베이스에 대한 장애 조치일뿐 읽거나, 수정하거나 할수없음
- 읽기전용 복제본 역시 다중 AZ로도 설정 가능하다
- 단일 AZ에서 다중 AZ로 RDS 데이터베이스 전환이 가능 - 다운타임 없음
- 마스터에서 DB 스냅샷을 생성하고 이를 통해 스탠바이 데이터베이스에 복원

RDS Custom

- RDS에서는 기저 운영체제나 사용자 지정 기능에 액세스 불가하나 custom은 가능
- 오라클, mysql server database 지원
- RDS: AWS에서의 데이터베이스 자동화 설정, 운영, 스케일링 장점
- CUSTOM 옵션: 기저 데이터베이스와 운영체제 액세스 가능
- 내부 설정 구성, 패치 적용, 네이티브 기능 활성화 가능
- SSH 또는 SSM 세션 관리자를 사용해서 RDS 뒤에 있는 기저 ec2 인스턴스 액세스 가능
- 자동화를 꺼두는것이 좋고 사용자가 문제를 발생시킬수 있으므로 스냅샷을 만들어두는것이 좋다

RDS Backup

- 자동 백업
    - 매일 정해진시간에 데이터베이스 전체 백업
    - 5분마다 트랜잭션 로그 백업
    - 백업기간 1~35일 설정
    - 비활성화 가능
- 수동 db 스냅샷 생성
    - 사용자가 직접 트리거
    - 원하는기간만큼 장기간 보유할수 있음
- 비용절감을 위해 정지 시키는것보다 스냅샷을 찍어놓는게 좋음

Amazon Aurora

- 대표 특징 : 자동 장애 조치, 백업 및 복구 , 격리 및 보안, 산업 규정 준수, 자동 스케일링을 통한 버튼식 스케일링, 제로 다운타임 자동패치설치, 고급 모니터링, 통상 유지관리, 백트랙(과거 어떤 시점의 데이터로도 복원 가능)
- Postgres 및 MYSQL가 호환가능
- RDS의 MYSQL보다 5배 높은 성능, Postgres 보다 3배 높은 성능
- 스토리지 자동확장 기능(10GB 시작 UP TO 128TB)
- 복제본 15개까지가능(mysql 은 5개). 복제속도 빠름
- 즉각적인 장애조치(다중az, mysql rds보다 훨씬 빠름)
- 비용 rds에 비해 20프로높음 - 효율적인 스케일링으로 비용 오히려 절감가능
- 사용자 지정 엔드포인트 정의 가능(더 큰 복제본을 지정해서 접근하고싶을때). 이경우 리더 엔드포인트는 사용하지않게됨
- 서버리스 기능 : 실제 사용량에 기반한 자동 데이터베이스 인스턴스화 및 자동 스케일 가능
- 멀티 마스터 - Writer 노드에 대한 즉각정 장애조치. 이경우 클러스터의 모든 노드에서 읽기쓰기 가능
- global aurora - 복제 지연이 1초 미만인 보조읽기 전용 리전을 5개까지 설정가능, 각 보조지역마다 읽기전용 복제본을 16개까지 생성 가능 → 리전에 걸쳐 데이터를 복제하는데 걸리는 시간은 평균 1초 미만
- 머신러닝 서비스(Amazon sagemaker - 모든모델 사용, Amazon Comprehend - 감정분석)와의 통합 지원
    - ML 기반 예측을 SQL 인터페이스로 애플리케이션에 적용
    - 활용 : 광고 타겟팅, 제품 추천, 감정 분석 등
- 높은 가용성과 읽기 스케일링
    - 3개 AZ에 걸친 6개 **복제본**(쓰기 - 4개, 읽기 - 3개)
    - P2P 복제를 통한 **자가복구**
    - 수백개 볼륨사용
    - 마스터 장애 시 평균 30초 이내로 장애조치 시작
    - 마스터에 문제가 생기면 읽기 전용 복제본 하나가 마스터가 되어 대체
    - 리전간 복제 지원
    - 작은 볼록 단위로 자가 복구 또는 확장이 일어남
    - 쓰기는 마스터만이 가능
    

Aurora DB Cluster

- writer endpoint 존재 - 마스터를 가르킴
- 읽기전용본 자동 스케일링 가능
- 1개 클러스터당 15개까지 읽기전용 복제본 가질수 있음
- reader endpoing
    - 연결로드 밸런싱에 도움
    - 읽기복제본들과 연결
    - 클라이언트가 리더 엔드포인트에 연결될때마다 읽기 endpoing에 연결되어 로드밸런싱을 도와줌 (문장레벨이 아닌 연결레벨에서 일어남)
    

Aurora backup

- 자동백업
    - 35일까지 보유가능
    - 비활성화 불가
    - 정해진 시간 범위내의 어느시점으로도 복구 가능
- 수동 db 스냅샷
    - 사용자 지정
    - 원하는기간 보존

RDS&Aurora 복원 옵션

- rds 및 aurora 백업 또는 스냅샷을 새로운 데이터베이스로 복원 가능
- s3로부터 MYSQL RDS 데이터베이스를 복원 가능
    - 온프레미스 데이터베이스의 백업을 만들어 객체 스토리지인 S3에 두는것
    - rds에는 s3에서 mysql을 실행중인 새로운 rds 인스턴스로 백업파일을 복원
- s3로부터 MYSQL Aurora 데이터베이스를 복원 가능
    - 온프레미스 데이터베이스를 외부로 다시 백업하고 **Percona Xtrabackup 소프트웨어 사용**
    - xtrabackup 백업 파일이 s3로 전송
    - 백업파일을 mysql 을 실행중인 새 aurora 클리스터로 복원하면됨

Aurora 데이터베이스 복제 기능

- 기존의 데이터베이스로부터 새로운 aurora db 클러스터를 만들수 있다.
- 스냅샷을 만들어 복원하는 것보다 빠름
- 비용 효율적
- 프로덕션 데이터베이스에 영향을 주지 않음

RDS & Aurora Security

- rds 및 aurora 데이터베이스에 저장된 데이터 암호화 가능
    - KMS를 사용해 마스터 및 복제본 암호화 - 데이터베이스 처음 실행시 정의
    - 마스터를 암호화하지않으면 복제본도 불가
    - 암호화되지않은 기존 데이터베이스를 암호화하려면 스냅샷을 가지고와서 암호화된 데이터베이스의 형태로 복원 필요 → 스냅샷 생성 및 복원 작업을 거쳐야함
- 클라이언트와 데이터베이스간의 전송 중 데이터 암호화
    - RDS 및 aurora db는 기본적으로 전송 중 데이터암호화 기능을 갖추고 있음
    - TLS 루트 인증서 사용
- IAM 인증 - IAM 역할을 사용하여 데이터베이스에 접속
- 보안그룹 사용 - 네트워크 액세스 통제
- SSH 액세스 불가 (rds custom 제외)
- 감시로그

RDS Proxy

- 어플리케이션이 데이터베이스 내에서 데이터베이스 연결 풀을 형성하고 공유할 수 있게해줌
- **RDS 데이터베이스 인스턴스의 연결 최소화**
- 커넥션 맺는 시간 최소화 및 효율적인 자원사용(cpu, ram)
- 서버리스 - 오토스케일링 가능, 다중 az 지원
- 장애 발생시 대기 인스턴스로 실행 - 장애조치시간을 66%까지 줄일수 있다
- mysql, postgresql, maridb용 rds/ mysql, postgresql용 aurora 지원
- 어플리케이션 코드 변경 필요 없음 rds 프록시에 연결만하면된다
- 데이터베이스에 IAM 인증을 강제 설정 가능 - 자격증명은 AWS Secret Manager 서비스에 안전하게 저장
- RDS는 퍼블릭 액세스가 절대 불가 - vpc에서만 접근 가능

Elastic Cache

- 관계형 데이터베이스 관리
- 레디스, 멤캐시트와 같은 캐시 기술을 관리 (두가지 비교 시험출제)
    - 캐시 : 높은성능과 낮은 지연시간을 가진 인메모리데이터베이스
    - redis - 고가용성, 백업, 읽기전용 복제본
        - 자동 장애 조치로 다중 AZ를 수행하는 기술.
        - 읽기전용 복제본은 읽기 스케일링에 사용되며 가용성이 높다
        - 지속성으로 인해 데이터 내구성 있음
        - 백업, 복원 기능
        - rdeis auth 를 사용하여 비밀번호, 토큰 설정 (보안그룹 외 추가적인 수준의 보안)
        - 전송 중 암호화를 위해 ssl 보안 지원
        - 사용사례 : 게임 리더보드(레디스 - 정렬된 집합 기능)
            - 정렬된 집합 : 요소가 추가될때마다 실시간으로 순위가 매겨진 다음 올바른 순서로 추가됨
    - 맴캐시트 - 데이터를 손실할 수 없는 단순한 분산 캐시
        - 데이터분할에 다중 노드 사용(sharding)
        - 복제 발생 x
        - 지속적인 캐시 x
        - 백업, 복원기능 x
        - 다중 스레드 아키테처
        - SASL 기반 인증 지원
- 읽기 집약적인 워크로드의 부하를 줄이는데 도움
- 어플리케이션을 stateless 상태를 만들수 있도록 해줌
- RDS와 동일하게 모니터링 백업, 복구, 패칭, 최적화 등을 해줌
- elasticcache로 cache hit한 쿼리들로 rds 데이터베이스에서 부하를 줄이는데 도움
- 캐시 무효화 전략
- IAM 인증을 지원하지 않음 (elastic cache 에서 iam 정책은 캐시 생성, 캐시 삭제 등 aws api 수준 보안에만 사용. 캐시내작업은 불가)
- 세션을 cache에서 관리하여 stateless 유지

Elastic cache 데이터 읽어오는법

- LAZY LOADING : 모든 읽기 데이터가 캐시되고 데이터가 캐시에서 부실해질 수 있음
- Write Through : 데이터가 캐시없을때마다 추가하거나 업데이트
- Session Store : Time to live 속성으로 세션 만료 가능