# Section14. 아마존 S3 보안

Date: June 10, 2023

**객체 암호화 ( 시험에선 어느것이 어떤 상황에 해당하는지 알아야함)**

- 전체를 암호화 하려면 버킷단위로 설정하고, 객체단위시에는 객체마다 설정
- 서버 측 암호화 (SSE, Server Side Encryption)
    - SSE-S3 : S3 관리형 키를 사용
        - AWS에서 처리, 관리, 소유하는 키로 암호화를 진행
        - 사용자는 이 키에 접근할 수 없음
        - AES-256 보안 유형으로 암호화가 이루어짐
        - 헤더를 “x-amz-server-side-encryption”: “AES256”으로 설정해야함
    - SSE-KMS: KMS키를 사용
        - KMS(Key Management Service)로 자신의 키를 직접 관리
            - kms 키에도 3개의 옵션이 있음
                - AWS키를 kms에서 관리
                - 자신의 kms키
                - 키 ARN(Amazon Resource Name)을 입력
        - 사용자가 키를 제어할 수 있음 - 직접 키를 생성하고 CroudTrail(KMS 키의 접근을 모두 기록)을 통해 감시가능
        - 헤더를 “x-amz-server-side-encryption”: “aws:kms”으로 설정해야함
        - 객체를 읽을때 KMS키에 대한 액세스도 추가적으로 필요하므로 보안에 굳
        - 제약 사항 : 업로드/다운로드 시 kms api를 호출하므로 kms 는초당 리전따라 5500,1000,3000 요청 가능
            - 많은 객체가 있는데 전체가 kms 로 암호화 되어있으면 스로틀링 오류 등 발생 가능
    - SSE-C : 고객의 제공하는 키(스스로 암호화키 제공해야함)
        - aws외부에서 키가 관리되지만 aws로 키를 보냄
        - 암호화키는 AWS에 저장되지 않고 사용하고 폐기
        - 매번 s3로 키를 전송하기 때문에 https를 사용해야하며 http 헤더에 키를 포함하여 전달해야함
        - 콘솔에서는 설정불가. CLI, SDK, API에서 사용 가능

- 클라이언트 측 암호화
    - 클라이언트측에서 직접 암호화하여 S3에 업로드, 복호화도 직접!
    - 클라이언트 라이브러리(AWS S3 Client-side encryption library등)로 쉽게 사용 가능
    - aws 는 인식하지못함
    
- 전송중 암호화 (SSL/TLS)
    - S3버킷에는 2개의 엔드포인트가 있음
        - HTTP 엔드포인트 - 암호화x
        - HTTPS 엔드포인트 - 전송중암호화
            - https를 사용하여 보안을 높이는것이좋다(sse-c 는 필수)

기본암호화 옵션 vs 버킷 정책

- 버킷 정책
    - 지정된 암호화 헤더가 없는 S3 객체를 버킷에 넣는 API 호출을 거부하여 암호화를 강제화할 수 있음
    - 암호화 전에 평가가됨
- 기본 암호화 옵션
    - 버킷정챗보다 좀 더 전략적,, s3에서 암호화 요청 여부와 상관없이 일단 암호화(?))

CORS 

- 교차 오리진 리소스 공유
    - origin = protocol + host(domain) + port
    - same origin = protocol, host, port가 동일할때(뒤에 경로는 달라도됨)
- 웹 브라우저 기반 보안 메커니즘
- 메인 오리진에 있는동안 다른 오리진에 대한 요청을 허용하거나 거부
- 허용하려면 header에 “Access-Control-Allow-Origin” 추가
- S3에서는 CORS헤더를 활성화
    - 빠른 작업을 위해서는 특정 오리진 or 모든 오리진 허용

MFA : 멀티팩터인증

**MFA DELETE**

- 추가 보호기능
- MFA 는 코드를 생성하는데 S3에서 중요한 작업을 수행하기 전에 S3에 해당 코드를 삽입해야함
- MFA DELETE의 사용
    - 객체버전 영구 삭제
    - 버킷에서 버저닝 중단
    - 사용필요없는 작업 : 버저닝 활성화, 삭제된 버전 나열
- 사용하려면 버킷에서 버저닝부터 활성화
- 버킷소유자 (**루트계정**)만이 MFA Delete 활성화/비활성화 가능
    - 콘솔에서 불가. cli 사용
    - 루트계정 mfa 설정 되어있어야함

S3 Access Logs

- 감사목적으로 S3 버킷에 대한 모든 액세스를 기록
- 어떤계정에서든 s3로 보낸 모든요청은 승인/거부에 상관없이 다른 s3 버킷에 파일로 기록
- 기록된 데이터를 데이터 분석도구(athena 등)로 분석 가능
- 대상 로깅 버킷은 같은 리전에 있어야함
- 주의사항
    - 모니터링 버킷과 동일하게 설정하면 안됨
        - 로깅 루프가 생성되게됨되어 버킷의 크기 기하급수적 증가

Pre-signed-Urls

- s3 콘솔, CLI, SDK를 사용하여 생성할 수 있는 url
- url 에는 만료 기한이 있음
    - 콘솔 사용 시 최대 12시간 , cli사용하면 최대 168시간
- url을 받는 사용자는 url을 생성한 사용자의 get/put 에 대한 권한을 상속
- 사례 : 외부 계정에 Private 버킷을 열어줘야할때 public으로 열면 보안상 위험함으로 pre-signed url을 사용함
    - 로그인한 사용자만 s3에서 프리미엄 비디오를 다운로드 할 수 있도록 허용
    - 사용자 목록 계속 변하는 경우
    - 일시적으로 사용자가 S3 버킷 특정 파일을 업로드할수록 허용
- url은 자격증명을 이어받아 해당 파일에 액세스 할 수 있는 권한 부여

s3 glacier vault lock (볼트 잠금)

- WORM 모델을 채용하기 위해 Glacier 볼트를 잠그는것
    - worm : 한번 쓰고 여러번 읽는다
- 객체를 가져와서 s3 glacier 볼트에 넣은다음 수정하거나 삭제 할 수 없도록 잠금
- 객체가 볼트에 들어가면 절대 삭제 불가
1. 볼트잠금정책 만듬
2. 향후 편집을 위하여 정책을 잠금 (누구도 변경 혹은 삭제 불가)
3. 규정 준수 및 데이터 보존에 유용

S3 객체 잠금

- 버저닝이 활성화된 상태에서 가능
- 법적 보존 상태 가능
    - s3 버킷 내 모든 객체를 무기한으로 보호 (보존 모드, 기간 상관 없음)
    - S3: PutObjectLegalHold IAM 기능을 가진 사용자는 법적 보존 상태 설정 및 제거 가능
- worm 모델
- 버킷내의 모든 객체에 각각 적용 가능한 잠금 (단일 객체 가능)
- 특정 객체가 특정시간동안 삭제되는것을 잠금
- 보존모드 2가지
    - 두가지 모두 기간 설정 필요(연장도 가능)
    - 규정 준수 모드 - 매우 엄격
        - s3 glacier vault lock **************와 유사**************
        - 사용자를 포함한 그누구도 덮어쓰거나 삭제 불가함
        - 누구도 객체 변경 불가
        - 보존모드 자체도 변경 불가
        - 보존기간 단축 불가
    - 거버넌스 보존 모드 - 유연성 있음
        - 규정 준수 모드보다는 조금 더 유연성이 필요할때
        - 대부분의 사용자는 덮어쓰기, 삭제, 로그설정 변경 불가
        - 일부 사용자에 한해 iam 을 통해 부여받은 특별 권한으로 보존 기간을 변경하거나 객체 바로 삭제 가능
        

S3 access points (ap)

- 사용자가 접근 권한설정 해야할 데이터가 세분화되면서 버킷 정책 대신 해당 기능을 사용 가능함
- ap에 정책을 연결
- 사용자 그룹에 ap를 매핑
- ap마다 고유의 dns와 정책이 있음
    - 사용자나 그룹의 액세스를 제한 가능
    

s3 object lambda

- s3 버킷 객체를 호출한 애플리케이션이 회수하기 전에 수정하기 위함
- 복제 없이 편집된 데이터를 얻을 수 있음
- origin object → s3 bucket → supporting s3 qp → lambda → s3 object lambda ap → redacted object
- 사용사례 :
    - 데이터 분석시 람다로 개인정보 삭제해서 데리고옴,,,
    - xml to json
    - 이미지 크기 변경
    - 워터마크