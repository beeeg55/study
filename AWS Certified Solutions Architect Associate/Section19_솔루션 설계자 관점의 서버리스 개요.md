# Section19. 솔루션 설계자 관점의 서버리스 개요

Date: June 17, 2023

serverless란?

- 개발자는 더이상 서버를 관리할 필요가 없어진 새로운 방식
- 함수를 배치하는것
- 시초는 FAAS(Function as a service)개념 지금은 더 확장
- 디비, 메세징, 스토리지 등 서버를 프로비저닝 하지 않는 모든것들
- 서버가 없는것이 아닌 서버가 보이지않거나 프로비저닝 하지 않는것

ec2

- 가상 서버로 프로비저닝 필요
- 메모리와 cpu크기 제한
- 지속적 실행으로 효율적인 관리 필요
- 오토스케일링그룹 - 추가 및 제거 작업 필요

→ 이러한 단점을 람다는 보안해줌

lambda

- 가상의 함수
- 관리할 서버없이 코드를 프로비저닝하면 함수가 실행
- 제한시간이 있어서 실행시간이 짧다
- 온디맨드로 실행(비용도 호출만큼, 람다로 실행시켜야만 호출됨)
- 자동스케일링
- 장점
    - 가격 측정 쉬움 - 수신요청횟수 + 컴퓨팅 시간 따라 과금
    - 다양한 aws 서비스와 통합
        - api gateway, kinesis, dynamodb, s3, cloudfront, cloud event eventbridge
    - 여러 프로그래밍 언어 지원
        - node.js, python, java, c#, golang, powershell, ruby, custum runtime api(community supported), lambda container image(이미지애 런타임 api 구현해야함, 구현되지 않은 경우엔 ecs/fargate 에서 컨테이너를 실행해야함)
    - cloudwatch와의 모니터링 통합 쉬움
    - 함수당 더많은 리소스를 프로비저닝 하려면 최대 10gb 램까지 프로비저닝 가능
    - ram을 증가시키면 cpu, 네트워크 같이 향상
- 다양한 AWS 서비스와 통합됨
    - api gateway - rest api를 생성하고 람다함수를 호출
    - kinesis : lambda를 이용해 바로 데이터를 변환
    - DynamoDB : 트리거를 생성할 때 사용. 디비에 무슨일이 생기면 람다 함수가 작동되게 함
    - S3 : 언제든 작동(s3 파일 생성 등 )
    - cloudfront : lambda@edge
    - cloudwatch events eventbridege : aws 의 인프라에 이벤트 발생 시 그 상황에 대응하고자 할때, 상황에 따른 자동화를 실행하려고 lambda 사용
    - cloudwatch logs : 어디든 해당로그 스트리밍
    - SNS : 알림과 sns 토픽에 대처 가능
    - SQS : SQS 대기열 메세지 처리 가능
    - cognito : 사용자가 데이터베이스에 로그인할때마다 응답
- 사용사례
    - 썸네일 생성
    - serverless cronjob : 한시간마다 트리거하여 태스크생성
- 가격책정(저렴)
    - 호출당 청구
        - 첫 1백만건 요청 무료
        - 1백만건 요청마다 20센트 과금
    - 1ms 단위로 요금 부과
        - 한달간 첫 40만 GB- 초 동안의 시간 무료
            - =1gb ram동안 실행시간 40만초
        - 이후 60만 GB- 초당 1달러 과금
        

Lambda 제한

- 실행한도
    - 실행 시 메모리 할당량 : 128mb~10gb(메모리는 1mb 씩 증가)
        - 메모리가 증가하면 더많은 vcpu 필요
    - 최대 실행 시간 : 900초(15분)
    - 환경변수 : 4KB까지
    - 큰파일 임시 공간 (경로 /tmp) : 최대 10GB
    - 최대 동시 실행 개수:  1000(더 증설 가능하긴함)
- 배포한도
    - 압축 시 최대 크기 : 50mb
    - 압축하지 않았을 때 : 250mb
    - 넘는경우에는 임시공간 tmp사용
    - 환경변수 : 4KB까지

Customization at the edge

- 엣지에서 로직을 실행하라고 요구하는 사항도 있음 → 엣지함수
- 엣지함수
    - cloudfront에 연결
    - 사용자 근처에서 실행하여 지연시간을 최소화하는것이 목적
    - 서버를 관리할 필요가 없음 (전역으로 배포되기 때문)
    - 종류
        - Cloudfront 함수
            - 자바스크립트로 작성된 경량 함수
            - 확장성이 높고 지연 시간에 민감한 CDN 사용자 지정에 사용
            - 시작 시간은 1밀리초 미만
            - 초당 백만개의 요청 처리
            - 뷰어(클라이언트) 요청과 응답을 수정할때만 사용
            - 모든 코드가 cloudfront에서 직접 관리
            - 고성능, 고확장
            - 사용사례
                - 캐시 키 정규화
                - 헤더 조작
                - url 리다렉션 or rewirte
                - 요청 허용 및 거부
                    - JWT 검증 및 생성하는 요청 인증 및 권한부여에도 사용
        - Lambda@Edge
            - node.js, python으로 작성
            - 초당 수쳔개의 요청 처리
            - 5-10초 실행가능(복잡한 로직 처리 가능)
            - 모든 cloudfront의 요청 및 응답 변경 가능(뷰어, 오리진 등)
                - viewer request- 뷰어 요청 받은 후
                - origin request : 오리진에 요청 보내기 전
                - origin response : 오리진 응답 받은 후
                - viewer response : 뷰어에 응답 던지기 전
            - us-east-1 리전에만 작성 가능(cloudfront 배포를 관리하는 리전임)
                - 작성하면 모든로케이션에 함수 복제됨
            - 사용사례
                - 여러 라이브러리 로드
                - 타사 라이브러리에 코드 의존(sdk에서 aws 액세스할 수 있도록)
                - 네트워크 액세스를 통해 외부 서비스에서 데이터 처리 가능 → 대규모 데이터 통합 수행
                - 파일 시스템이나 http 요청 본문에도 액세스 가능
    - 사용사례
        - cdn 콘텐츠를 사용자 지정
        - 웹 사이트 보안과 프라이버시
        - 엣지에서의 동적 웹 어플리케이션
        - 검색엔진 최적화(seo)
        - 오리진 및 데이터 센터간 지능형 경로
        - 엣지에서의 봇 완화
        - 엣지에서의 실시간 이미지 변환
        - A/B 테스팅
        - 사용자 인증 및 권한 부여
        - 사용자 우선순위 지정
        - 사용자 추적 및 분석
    - 사용한만큼만 비용지불
    - full serverless
    
    Lambda by default
    
    - 람다함수는 사용자 VPC 외부에서 일반적으로 시작 → vpc 내 리소스(Private rds) 등 에 접근할수없음
    
    Lambda in VPC
    
    - 람다함수를 추가하고싶은 VPC ID를 서브넷을 지정하고 lambda함수에 보안그룹을 추가해야함
    - 람다는 서브넷에 ENI 를 생성해 접근을 가능하게 해줌
    - private 필수
    - Lambda with rds proxy
        - 대표적인 vpc내 람다 사용 사례
        - rds proxy를 사용하면 연결을 하나로 모으고 rds 데이터베이스 인스턴스 연결의 수를 줄임
        - lambda 함수가 rds 프록시에 연결, rds프록시가 rds db 인스턴스로 연결
        - 장점
            - 데이터베이스 연결의 풀링과 공유를 통해 확장성 향상
            - 장애 발생 시 조치시간 66프로까지 줄여 가용성 향상 및 연결 보존(rds, aurora 모두)
            - rds 프록시 수준에서 iam 인증을 강제하여 보안을 높일 수 있으며 자격증명은 secrets manager에 저장
        - 람다 함수가 rds 프록시에 연결할 수 있으려면 내 VPC에서 함수를 시작해야함(rds는 private 니까)

Amazon DynamoDB

- 완전 관리형 데이터베이스
- 데이터가 다중 az간 복제되어 높은 가용성
- 클라우드 네이티브이며 aws의 독점서비스
- nosql database(관계형 x 이나 트랜잭션 지원 기능 있음)
- 데이터베이스가 내부에서 분산되어 방대한 워크로드로 확장 가능
- 초당 수백만개의 요청 처리하며 수조개의 행, 수백 TB의 스토리지 갖게됨
- 성능 한 자릿수 밀리초. 일관성 높음
- 보안관련기능은 iam과 통합되어있음(보안, 권한 부여, 관리 기능)
- 비용이 적게들고 오토 스케일링 기능 탑재
- 유치 관리나 패치 없이도 항상 사용가능(프로비저닝 필요x)
- 2종류 클래스
    - standard 클래스 - 빈도수 잦은 데이터
    - IA 테이블 클래스 - 빈도 수 적은 데이터
- 테이블로 구성되며 데이터베이스를 생성할 필요 없음
    - 데이터베이스가 이미 존재하는 서비스
- 테이블 생성 시 각 테이블에 기본 키 부여
- 행열 무한히 나중에도 간편하게 추가 가능
- 항목 최대크기 : 400kb (큰 객체를 저장하기엔 적합하지 않음)
- 다양한 유형 타입 지원
    - 스트링, 넘저, binary, boolean, null
    - list, map
    - string set, number set, binary set
- 스키마를 빠르게 전개해야할때 dynamodb 를 선택하면 좋다
- 기본 키 : 파티션 키 + 솔트키(옵션)
- 읽기/쓰기 용량 모드 설정 필요
    - 2가지 모드
        - 프로비저닝 모드(비용 절감)
            - 미리 용량을 프로비저닝하고 프로비저닝 된 rcu와 wcu만큼의 비용 지불
                - rcu : 읽기 용량 유닛
                - wcu : 쓰기 용량 유닛
            - 초당 읽기/쓰기 요청수를 예측해서 미리 지정
            - 오토 스케일링 지원(rcu, wcu 스케일링 가능)
        - 온디맨드 모드
            - 워크로드에 따라 읽기/쓰기 용량 자동 확장
            - 미리 계획하지 않으므로 rcu, wcu 개념자체가 없다
            - 사용한만큼 지불
            - 워크로드를 예측할 수 없거나, 급격히 증가하는 경우에 유용

DynamoDB Accelerator(DAX)

- dynamodb를 위한 고가용성의 완전 관리형 무결절 인메모리 캐시
- 테이블에 읽기 작업이 많을 때 DAX 클리스터를 생성하고 데이터를 캐싱하여 읽기 혼잡을 해결
- 캐시 데이터에 마이크로초 수준의 지연시간 제공
- 기존 Dynamodb api와 호환되므로 애플리케이션 로직을 변경할 필요가 없음
- ttl 기본셋팅: 5분
- elastic cache vs dax
    - dax
        - db 앞에 위치
        - 개별 객체 캐시
        - 쿼리와 스캔 캐시를 처리하는데 유용
    - elastic cache
        - 집계 결과를 저장하는데 좋음

DynamoDB - Stream Processing

- 테이블의 모든 수정사항(생성, 업데이트, 삭제)를 포함한 스트림 생성 가능
- 사용사례
    - 새로운 사용자에게 welcom email 실시간 처리
    - 실시간 사용 분석
    - 파생 테이블 삽입
    - 리전간 복제
    - 변경사항에 대해 람다 실행
- 2가지 유형
    - dynamodb strams
        - 보존 기간 24시간
        - 소비자 수 제한
        - lambda 트리거와 함께 사용시 좋음
        - 자체적 읽기를 실행하려면 dynamodb stream kinesis adapter(ec2) 사용
    - kinesis data streams(newer)
        - kinesis data stream에 바로 보내는 방법
        - 보존기간 1년
        - 더 많은 사용자수
        - 데이터 처리방법 많음
            - lambda, kinesis data analytics, kinesis data firehose, aws glue streaming etl…
    

DynamoDB Global Tables

- 여러 리전간에 복제가 가능한 테이블
- 양방향 복제가 가능
- 짧은 지연시간으로 액세스 가능
- 다중 활성 복제 가능
- 어플리케이션이 모든 리전에서 테이블을 읽고 쓸 수 있다
- 활성화하려면 dynamodb 스트림을 활성화해야 리전간 복제 가능한 구조 가능

DynamoDB - Time To Live(ttl)

- 만료 타임 스탬프가 지나면 자동으로 항목 삭제
- 사용사례
    - 최근 항목만 저장
    - 2년후 데이터 삭제해야한다는 규정
    - 웹 세션 핸들링
        - 로그인했을때 중앙저장소인 dynamodb에 두시간동안 세션데이터를 저장하여 모든 애플리케이션이 액세스 가능하고 두시간 후에 세션이 갱신되지 않으면 만료되어 삭제

DynamoDB - 재해복구 (백업)

- 옵션 1. 지정 시간 복구(PITR/ POINT-IN-TIME RECOVERY) 를 사용하여 지속적인 백업 가능
    - 활성화를 선택할 수 있고 35일동안 지속
    - 활성화하면 백업 기간 내에는 언제든 지정 시간 복구 실행 가능
    - 복구를 진행할 경우 새로운 테이블 생성
- 옵션 2. 온디맨드 백업
    - 더 긴 백업 옵션으로, 직접 삭제할때까지 보존
    - dynamodb의 성능이나 지연시간에 영향을 주지 않음
    - aws backup 서비스 관리 가능
        - 백업에 수명주기 정책 활성화 가능
        - 리전간 백업 복사 가능
    - 복구를 진행할 경우 새로운 테이블 생성

Dynamodb와 s3간 통합

- s3에 데이터 내보내기(지정시간복구기능(PITR) 활성화 해야함)
    - 35일간 지속 가능
    - 테이블을 내보내도 읽기 용량이나 성능에 영향을 주지 않음
    - dynamodb를 s3로 먼저 내보내기 하여 데이터 분석 수행 가능
    - 스냅샷 가능
    - 데이터를 다시 가져오기 전 데이터 etl등 대규모 변경 실행 가능
    - dynamodb json이나 ion 형식 이용
- S3에서 테이블 가져오기
    - S3에서 csv, json, ion형식으로 내보낸 다음 새로운 dynamodb 테이블을 생성하는 방식
    - 쓰기 용량을 소비하지 않고 새로운 테이블 생성
    - 가져올때 발생한 오류는 cloudwatch logs 에 기록됨

AWS API Gateway

- AWS 서비스를 외부에 노출시킬수 있다
- lambda + api gateway = full serverless application
- 웹 소켓 프로토콜 지원
- 2가지 방법의 실시간 스트리밍 가능
- API 버저닝을 핸들링하여 클라이언트가 끊기지 않음
- dev, test, prod 등 여러 환경을 핸들링
- 보안 활용 가능(인증, 권한 부여 등)
- api 키 생성 가능, api gateway에 클라이언트 요청이 과도할 때 요청 스로틀링 가능
- swagger, openapi 등 공통 표준을 사용하여 신속히 api를 정의하여 가져올 수 있고 내보낼 수도 있음
- 요청과 응답을 변형하거나 유효성검사 가능
- sdk나 api 스펙 생성 가능
- api 응답 캐시

AWS API Gateway 통합 기능

- lambda function
    - 지연 호출
    - 람다 함수를 사용하는 rest api를 완전 서버리스 애플리케이션에 노출
- http
    - 백엔드의 http 엔드포인트를 노출
    - 속도제한 기능, 캐싱, 사용자 인증, api 키 등의 기능 추가 가능
    - http 엔드포인트에서 api gateway 계층을 활용하는 것
- aws service
- 어느 aws api도 노출 가능
- 사례
    - aws step function workflow 시작 가능
    - sqs에 메세지 게시인증 추가하거나 api를 퍼블릭으로 배포하거나 특정 aws 서비스에 속도제한을 추가하기 위해 통합하는 것
    

Api Gateway 배포 유형 3가지(엔드포인트 유형)

- 엣지 최적화 : 글로벌 클라이언트용
    - 모든 요청이 cloudfront 엣지 로케이션을 통해 라우팅되어 지연시간  개선
    - api는 생성된 리전에 위치하지만 모든 엣지 로케이션에서 액세스 가능
- Regional
    - 엣지 로케이션을 원하지않을때는 리전배포 사용
    - 모든 사용자는 api gateway를 생성한 리전과 같은 리전에 있어야함
    - 자체 cloudfront배포 생성 가능
    - 엣지 초적화 배포와 동일한 결과(캐시 전략과 cloudfront 설정에 더 많은 권한을 가질 수 있음)
- private
    - vpc내에서만 접근 가능
    - eni 같은 인터페이스 vpc 엔드포인트를 사용
    - 액세스 정의 시 리소스 정책 사용

api gateway 보안

- 사용자 식별 방법
    - iam - 내부 애플리케이션 액세스 시 유용
    - 외부 사용자에 대한 보안 조치로 cognito 사용
    - 사용자 지정 권한 부여자(람다 등 자체 로직 실행 가능)
- Custom Domain Name HTTPS security with acm
    - 사용자 지정 도메인 이름을 aws certificate manager(acm)과 통합
    - 엣지 최적화 엔트포인트 사용할 경우 인증서는 us-east-1에 있어야함
    - 리전 엔드포인트를 사용할 경우, 인증서는 api gateway 단계와 동일한 리전에 있어야함
    - route53이나 a 별칭 레코드를 설정해 도메인 및 api gateway를 가리키도록 해야함

AWS Step Function

- 서버리스 워크플로를 시각적으로 구성할 수 있는 기능
- 주로 람다 함수를 오케스트레이션하는데 활용(ec2, ecs, 온프레미스 서버, api gateway, sqs queue 등도 가능)
- 그래프를 만듬
- 제공 기능 : 시퀀싱, 병행 실행, 조건 설정, 타임아웃, 에러처리 등
- 사람이 개입해서 승인해야만 진행되는 단계 설정 가능
- 사용사례
    - 주문 이행
    - 데이터 처리
    - 웹 어플리케이션