# Section26. AWS 보안 및 암호화 : KMS, SSM Parameter store, cloudHSM, Shield

Date: June 24, 2023

전숭 중 암호화(ssl)

- 중간자 공격으로부터 보호
- 서버가 데이터를 받으면 복호화
- ssl 인증서가 암호화를 해줌(https)
- 초록색 자물쇠 + 인증서가 유효
- 모든 프로그래밍 언어 지원

서버측 저장데이터 암호화

- 데이터가 서버에 수신된 후 암호화
- 서버가 암호화된 형태로 저장
- 해킹당할 경우 대비
- 클라이언트로 다시 전송되기 전 복호화
- 데이터 키로 암호화
    - 주로 kms(key manager service) 같은 곳에 따로 키 관리
    - 서버는 kms와 통신 할 수 있어야함

클라이언트측 암호화

- 클라이언트가 암호화하고 서버는 복호화 불가
- 데이터를 받는 클라이언트에 의해 복호화
- 서버는 내용을 알 수 없음
- 봉투 암호화를 사용

kms(key management service)

- aws 에서 암호화 키를 관리
- kms는 권한 부여를 통해 iam 과 완전히 통합
- kms로 암호화된 데이터에 관한 액세스 제어하기 쉬움
- cloudtrail을 통해 키를 사용하기 위해 호출한 모든 api 감시 가능
- 대부분의 aws서비스에서 사용 가능 (ebs,s3, rds, ssm등)
- 리전에 따라 범위 지정
    - 스냅샷 이용 ( 다른 kms키나 이를 aws가 알아서 처리)
- 암호 데이터는 절대로 평문으로 저장하면 안됨
    - kms api호출 가능(cli, skd 가능)
    - 어떤 파일이든 암호화 가능하며 이러한 파일은 코드나 환경 변수에 저장

kms 키 유형

- 대칭 kms 키(AES-256 키)
    - 암호화, 복호화 동일 키
    - 모든 aws 서비스는 대칭 kms 키를 사용함
    - 대칭키를 생성하거나 사용하면 키 자체는 절대 접근 불가하며 api를 통해 사용
- 비대칭 키(RSA & ECC key pair)
    - 암호화에 사용하는 public키, 복호화에 사용하는 private 키 2개 사용
    - 암호화, 복호화와 작업할당 및 검증에 사용
    - kms에서 퍼블릭 키를 다운로드 할 수 있지만, private키는 액세스 불가(api 호출로 사용)
    - 사용 사례 : kms api 키에 액세스 할 수 없는 사용자가 aws 클라우드 외부에서 암호화 사용할 때
- 총 3가지 유형의 키 유형이 있음
    - AWS 관리형 키
        - aws/rds 와 같이 저장됨
        - 무료 서비스
        - aws에서 관리
        - 특정 서비스에 관한 암호화 시 사용
    - 고객 관리형 키(cmk) -  생성 가능하며 (매달 1달러 비용)
    - 자체 키 구성요소를 kms에 가져올 수있음 (매달 1달러 비용)
- kms로 api를 호출할때 비용듬(10000 call 당 0.03달러)
- 보안을 위해 자동으로 키 교체하도록 설정 가능
    - aws 관리형 키는 자동으로 1년에 한번씩 교체
    - customer-managed kms 키는 반드시 교체되도록 활성화 해야함( 매년 교체되며, 교체빈도 수정 불가)
    - 자체 키는 수동으로면 키 교체 가능하며 키 별칭을 사용해서 바꿔야함
    - 

kms 키 정책

- kms 키에 관한 액세스를 제어하는 것
- kms 키 정책이 없으면 누구도 접근 불가
- 2가지 유형 정책
    - 기본 정책
        - 사용자 지정 키 정책을 제공하지 않으면 생성
        - 계정의 모든사람이 액세스 하도록 허용함
    - custom kms key policy
        - kms 키에 액세스 할 수 있는 사용자 또는 역할 정의
        - 키 관리자를 정의할 수 있는 정책을 사용
        - 교차계정액세스시 유용 (다른계정이 키 사용 못하도록)
        - 사례 : 스냅샷 다른계정에서 복사할때
- KMS 다중 리전 키
    - 다른 aws 리전에서 사용할 수 있는 kms 키 세트로 서로 교차에서 사용 가능
    - **한 리전에서 암호화 후 다른 리전에서 복호화 가능**
    - 동일한 키 id 와 동일한 키 구성 요소를 갖음
    - 기본키의 자동교체는 다른 리전도 같이 복제
    - 복제나 교차리전 api호출을 실행할 때 데이터를 재 암호화 하지 않아도 됨
    - 전역으로는 사용할 수 없다
    - 다중 리전키는 자에 키 정책등으로 각각 관리
    - 권장하지 않음(단일리전을 선호)
    - 사용사례
        - 전역 클라이언트 측 암호화
            - 데이터의 특정 필드 보호 가능
        - dynamo db 전역테이블, 오로라 등
            - aws encryption sdk 사용
            

S3 복제와 암호화된 객체의 연관성

- s3복제 활성화 시 SSE-S3로 암호화된 객체 및 되지않은 객체 복제됨
- s3복제 활성화 시 SSE-C로 암호화된 객체 및 되지않은 객체 복제되지 않음
    - 항상 키를 제공할 수 없기 때문
- SSE-KMS
    - 기본 복제되지 않지만 옵션 활성화로 가능
        - 어떤 kms 키 인지 지정
    - kms 키 정책을 대상 키에 적용해야함
    - s3 복제 서비스를 허용하는 iam 역할을 생성해서 소스 버킷의 데이터를 먼저 복호화하도록 한 뒤 대상 Kms 키로 데이터 다시 암호화
    - kms 스토롤링 오류가 발생한 경우는 서비스 할당량 요청
- 다중리전키를 사용할 수 있으나 현재는 독립키로 취급함

암호화된 ami 공유 프로세스 

1. ami 는 kms 키로 암호화 되어 있음
2. 시작 권한으로 ami 속성을 수정 (시작권한을 다른 계정에서 ami 시작하도록 허용)
3. kms 키 공유를 위해 키 정책이 실행
4. iam 역할이나 사용자 생성하여 api 호출에 관한 kms 측 액세스 권한을 넣어줌
5. ami에서 ec2 인스턴스 시작(선택옵션: 대상계정에서 자체 계정의 볼륨을 재암호화하는 kms 키를 이용해 재암호화 가능)

SSM PARAMETER STORE 

- 구성 및 암호를 위한 보안 스토리지
- KMS를 이용해 구성을 암호화할지 선택가능
- 서버리스이며 확장성과 내구성이 있음. SDK 사용 용이
- 매개변수를 업데이트 할때 버전 추적 가능
- IAM 통한 보안
- EVENTBRIDGE로 알림 가능
- cloudformation 통합 가능(파라미터 스토어의 매개변수를 스택의 입력 매개변수로 활용 가능)
- 계층(트리)구조로 원하는대로 구조화 가능
- 퍼블릭 매개변수도 사용 가능(예 - 최신 ami 찾을때)
- 버전 보관
- 2가지 티어
    - 기본
        - 용량 4kb
        - 매개변수 정책 적용 안됨
        - 무료
    - advanced
        - 용량 8kb
        - 매개변수 정책 적용 가능
        - 0.05달러 지불
- 매개 변수 정책
    - ttl 적용 가능
    - 한번에 여러 정책 할당 가능

AWS Secrets Manager

- 암호를 저장하는 서비스
- X일 때마다 강제로 암호를 교체하는 기능이 있어 암호 관리 효율적
- 교체할 암호 강제 생성 및 암호화 가능(람다 사용)
- 다른 서비스와 통합
    - RDS(MYSQL, PostgreSQL, Aurora) 외 여러 서비스와 데이터베이스에서도 즉시 통합 가능
- KMS 서비스를 통해 암호화
- 다중 리전 암호
    - 복수 aws 리전에 암호 복제 가능
    - 기본 암호와 동기화된 읽기 전용 복제본 유지
    - 한 리전에 문제 발생시 복제본을 독립실행형 암호로 승격 가능
    - 사용사례
        - 다중리전 앱 제작
        - 재해 복구
        - 멀티 리전 데이터베이스

AWS Certificate Manager

- TLS 인증서를 aws에서 프로비저닝, 관리, 배포하게 해줌
- 웹 사이트에서 전송 중 암호화를 제공하는데 쓰임(https)
- public, private tls인증서 둘 다 지원
    - 퍼블릭은 무료
- 인증서 자동 갱신 기능
- 여러 aws 서빗와 통합
    - elb
    - cloudfront
    - api gateway
- ec2에서는 사용 불가함

퍼블릭인증서 요청 과정

1. 인증서에 포함할 도메인 이름 나열(풀, 와일드 카드 등)
2. 유효성 검증 방법(dns or email)
    1. dns 검증 - 자동화 시 사용하는 것이 좋음
3. 유효성 검증후 인증서 발행
4. 퍼블릭 인증서도 자동 갱신 목록에 추가됨
    1. acm에서 스스로 생성한 모든 인증서를 만료 60일전 자동 갱신

ACM 에서 public 인증서 가져오는법

- ACM외부에서 생성된 인증서를 ACM으로 가져오는 옵션 제공
    - 자동 갱신은 불가
    - 만료되기 전 직접 갱신
    - acm이 만료 45일전부터 매일 eventbridge로 이벤트 전달
- AWSconfig - 만료된 인증서 확인 규칙(acm-certificate-expiration-check) 으로 만료일 체크 가능
    - 일 수 조정 가능

acm서비스 ALB와의 통합

- alb는 http로 https 리다이렉트를 해주기도함
- https는 ACM에서 나오는 tls 인증서 사용

API GATEWAY- ENDPOINT TYPES

- 엣지 최적화
    - 글로벌 클라이언트를 위함
    - cloudfront 엣지 로케이션으로 요청을 라우팅 하여 지연을 줄이는 방법
    - 하나의 리전에만 있는 api gateway로 보내지는 경우
- regional
    - 클라이언트가 api gateway와 같은 리전에 있을때 사용
    - cloudfront 사용 불가하나 자체 cloudfront 배포를 생성하여 캐싱 및 배포전략 제어
- private
    - vpc 엔드포인트 eni를 통해 vpc내부에만 액세스 가능
    - 액세스 정의하는 리소스 정책 필요

→ acm은 엣지 최적화와 regional에 적합함

ACM - API GATEWAY와 통합

API GATEWAY에 custom domain name 생성

- 엣지 최적화
    - tls 인증서가 cloudfront와 같은 리전인 us-east-1에 생성
- regional
    - tls인증서가 api-gateway와 같은 리전에 있어야함

AWS 웹 어플리케이션 방화벽(WAF)

- 계층 7에서 일어나는 일반적인 웹 공격으로 부터 보호
- layer 7: http 취약점 보호
- waf 배포(nlb 등 오답으로 시험에서 바꿔나올 수 있음)
    - alb
    - api gateway
    - coudfront
    - appsync graphql api
    - congito user pool
- 웹 액세스 제어 목록(ACL)과 규칙 정의해야함
    - 규칙 예시
        - ip주소
        - http 헤더, 바디 ,uri, xxs(cross-site-scripting)
        - 용량 제약, 지역 일치 조건
        - 속도 기반 규칙(ddos 막기)
- 리전에만 적용(cloudfront만 글로벌로 예외)
- 규칙그룹 : 여러웹 acl에 추가할 수 있는 재사용 가능 규칙
- web acl은 alb 리전과 같은 곳에 위치해야함

AWS Shield

- 디도스 공격으로 부터 보호받기위한 서비스
- aws shield standard
    - 무료로 활성화 가능
    - syn/udp floods, 반사 공격, layer3/layer4 공격으로부터 고객을 보호해줌
- aws shield advanced
    - 조직당 월 3000달러
    - 더욱 정교한 디도스 공격 막아줌
        - ec2, elb, cloudfront, acclerator, route53 대상
    - ddos 대응 팀 지원 가능
    - 자동 어플리케이션 계층 디도스 완화도 제공하여 자동으로 waf 규칙을 생성, 평가, 배포함으로써 l7공격을 완화도 가능

firewall manager

- aws organiztions에 있는 모든 계정의 방화벽 규칙을 관리하는 서비스
- 여러 계정의 규칙을 동시에 관리 가능
- 보안 규칙의 집합인 보안 정책 정의 가능
    - 방화벽 규칙(alb, api gateway, cloudfront을 위함)
    - aws shield advanced(alb, clb, nlb, elastic ip, cloudfront를 위함)
    - 보안 그룹
    - aws network firewall(vpc level)
    - amazon route53 resolver dns firewall
    - 정책은 리전 수준에서 정의
    - 조직에 등록된 모든 계정에 적용

waf vs firewall manager vs shield

- waf - 리소스별 보호를 구성할때 적절
- firewall manager - 여러 계정에서 waf를 사용하고 새로운 리소스도 자동 waf  규칙을 적용되기를 원할때 적절
- shield - 디도스 공격으로부터 고객을 보호하고 waf 보다 더 많은 기능

DDOS 보호와 모범 사례

AWS GuardDuty

- aws 계정을 보호하는 지능형 위협 탐지 시스템
- 머신러닝 알고리즘, 이상탐지, 타사 데이터를 이용하여 계정에 대한 공격 탐지
- 클릭한번으로 활성화(30일 평가판)
- 소프트웨어 설치 필요없음
- 입력 데이터 종류
    - cloudtrail이벤트로그 - 비정상적 api 호출과 무단배포
    - cloudtrail s3 데이터이벤트
    - vpc flow 로그 - 비정상적인 트래픽
    - dns logs
    - kubernetes 감사로그 - eks 클러스터 손상
- cloudwatch로 이벤트로 sns, lambda 등을 통해 알림설정 가능
- 암호화폐 공격 보호 가능

amazon inspector

- 몇 군데에서 자동화된 보안평가를 실행 가능
- 아래 3가지 대상에서만 작동
- 대상1 : 인스턴스 서비스
    - ssm(aws system manager)에서 보안 평가
    - 네트워크 접근 가능성 분석
    - 실행중인 운영체제 취약점 분석
- 대상2: ecr로 컨테이너 이미지 푸시할 때
    - 이미지가 푸시되면 알려진 취약점에 대해 검사
- 대상3 : lambda
    - 함수 코드및 종속성, 소프트웨어 취약점을 람다 배포될 때 검사
- 작업 완료 후 aws 보안 허브에 보고 및 aws eventbridge에 전달하여 인프라에 있는 취약점을 모아서 볼 수 있고 자동화 가능
- 필요할땐 인프라를 지속적 스캔
- 취약성 데이터베이스 cve로 ec2, ecr, lambda에서 패키지 취약성 검사
    - cve가 업데이트 되면 자동으로 다시 실행하여 테스트
- ec2에서 네트워크 도달성을 살펴봄

macie

- 완전 관리형의 데이터 보안 및 데이터 프라이버시 서비스
- 머신 러닝과 패턴 일치를 사용하여 aws의 민감한 정보를 검색하고 보호함
- 민감한 데이터를 경고(개인식별 정보 등)
- 예시 : s3를 분석후 개인식별정보로 유추되면 eventbridge로 notify